%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%          
\section{Proof of Separation}
\label{sec:proof-separation}

This proof can be found in the file \verb|Separation_Axiom.thy| of the
development, which we proceed to discuss in detail. The order chosen to
implement
the proof sought to minimize the cross-reference of facts;  it is
not entirely appropriate for a text version, so we depart from it in
this presentation. Nevertheless, we will refer to each specific block
of code by line number for ease of reference.

The key technical result is the following:
\begin{isabelle}
  \isacommand{lemma}\isamarkupfalse%
  \ Collect{\isacharunderscore}sats{\isacharunderscore}in{\isacharunderscore}MG\ {\isacharcolon}\isanewline
  \ \ \isakeyword{assumes}\isanewline
  \ \ \ \ {\isachardoublequoteopen}{\isasympi}\ {\isasymin}\ M{\isachardoublequoteclose}\ {\isachardoublequoteopen}{\isasymsigma}\ {\isasymin}\ M{\isachardoublequoteclose}\ {\isachardoublequoteopen}val{\isacharparenleft}G{\isacharcomma}\ {\isasympi}{\isacharparenright}\ {\isacharequal}\ c{\isachardoublequoteclose}\isanewline
  \ \ \ \  {\isachardoublequoteopen}val{\isacharparenleft}G{\isacharcomma}\ {\isasymsigma}{\isacharparenright}\ {\isacharequal}\ w{\isachardoublequoteclose}\isanewline
  \ \ \ \ {\isachardoublequoteopen}{\isasymphi}\ {\isasymin}\ formula{\isachardoublequoteclose}\ {\isachardoublequoteopen}arity{\isacharparenleft}{\isasymphi}{\isacharparenright}\ {\isasymle}\ {\isadigit{2}}{\isachardoublequoteclose}\isanewline
  \ \ \isakeyword{shows}\ \ \ \ \isanewline
  \ \ \ \ {\isachardoublequoteopen}{\isacharbraceleft}x{\isasymin}c{\isachardot}\ sats{\isacharparenleft}M{\isacharbrackleft}G{\isacharbrackright}{\isacharcomma}\ {\isasymphi}{\isacharcomma}\ {\isacharbrackleft}x{\isacharcomma}\ w{\isacharbrackright}{\isacharparenright}{\isacharbraceright}{\isasymin}\ M{\isacharbrackleft}G{\isacharbrackright}{\isachardoublequoteclose}
\end{isabelle}
%
From this, using absoluteness, we will be able to derive the
$\phi$-instance of Separation. 

To show that   
\[
S\defi\{x\in c : M[G],[x,w]\models \phi(x_0,x_1)\} \in M[G],
\]
it is enough to provide a name $n\in M$ for this set.
 
The candidate name is
\begin{equation}\label{eq:4}
n \defi \{u \in\dom(\pi)\times\PP :M,[u,\PP,\leq,\1,\sig,\pi]\models \psi\}
\end{equation}
where
\[
\psi \defi \exists \th\, p.\ x_0=\lb\th,p\rb \y 
   \forceisa(\th\in x_5\y\phi(\th,x_4)).
\]
The fact that $n\in M$ follows (lines 216--220 of the source file) by
an application of a six-variable instance of Separation in $M$ (lemma
\isatt{six{\isacharunderscore}sep{\isacharunderscore}aux}). We note in
passing that it is possible to  abbreviate expressions in Isabelle by
the use of the  \textbf{let} statement or the \textbf{is} qualifier,
and metavariables (whose
identifiers start with a question mark). In this way, the definition in
(\ref{eq:4}) appears in the sources as letting \isatt{?n} to be that
set (lines 208--211).

Almost a third part of the proof involves the syntactic handling of
internalized formulas and permutation of variables. The more
substantive portion concerns proving that actually $\val(G,n)=S$.

Let's first focus into the predicate 
\begin{equation}\label{eq:1}
M,[u,\PP,\leq,\1,\sig,\pi]\models \psi
\end{equation}
defining $n$ by separation. By definition of the satisfaction
relation and %% permuting variables
absoluteness, we have (lines 92--98) that it is equivalent to the fact
that there exist $\th,p\in M$ with   $u=\lb\th,p\rb$  and 
\[
M,[\PP,\leq,\1,p,\th,\sig,\pi]\models \forceisa(x_4\in
x_6\y\phi(x_4,x_5)). 
\]
% (Note that the variable $x_7$ is not used.)
This, in turn, is equivalent by the Definition of Forcing to: \emph{For all $M$-generic
filters $F$ such that $p\in F$,} 
\begin{equation}\label{eq:2}
M[F],[\val(F,\th),\val(F,\sig),\val(F,\pi)]\models x_0\in
x_2\y\phi(x_0,x_1). 
\end{equation}
(lines 99--185). We can instantiate this statement with $G$ and obtain
(lines 186--206)
\[
p\in G \impl M[G],[\val(G,\th),w,c]\models x_0\in
x_2\y\phi(x_0,x_1). 
\] 
Let $Q(\th,p)$ be the last displayed statement. We have just seen that
(\ref{eq:1}) implies 
\[
\exists \th,p\in M.\ u=\lb\th,p\rb \y Q(\th,p).
\]
Hence (lines 207-212) $n$ is included in 
\[
m\defi \{u \in\dom(\pi)\times\PP : \exists \th,p\in M.\ u=\lb\th,p\rb
\y Q(\th,p)\}. 
\]

Since $m$ is a name defined using Separation, we may use
(\ref{eq:val-name-sep}) to show (lines 221--274 of
\isatt{Separation\_Axiom})
\begin{equation}
  \label{eq:val-of-m}
  \val(G,m) = \{x\in c : M[G],[x,w,c]\models \phi(x_0,x_1)\}.
\end{equation}
The right-hand side is trivially equal to $S$, but as a consequence of
the definition of 
\isatt{separation\_ax}, the result contains an extra $c$ in the
environment.

Also, by monotonicity of $\val$ we obtain 
  $\val(G,n)\sbq \val(G,m)$ (lines 213--215).
To complete the proof, it is therefore enough to show the other
inclusion (starting at line 275).
%$\val(G,m)\sbq \val(G,n)$ 
For this, let $x\in \val(G,m) = S$ and then $x\in c$. Hence there exists
$\lb\th,q\rb\in\pi$ such that $q\in G$ and $x=\val(G,\th)$. 

On the other hand, since (line 297)
\[
M[G],[\val(G,\th),\val(G,\sig),\val(G,\pi)]\models
 x_0\in x_2\y\phi( x_0, x_1),
\]
by the  Truth Lemma there must exist $r\in G$ such that
\[
M,[\PP,\leq,\1,r,\th,\sig,\pi]\models
\forceisa(x_4\in x_6\y\phi( x_4, x_5)).
\]
Since $G$ is a filter, there is $p\in G$ such that $p\leq q, r$.
By Strengthening, we have
\[
M,[\PP,\leq,\1,p,\th,\sig,\pi]\models
\forceisa(x_4\in x_6\y \phi( x_4, x_5)),
\]
which by the Definition of Forcing gives us (lines 315--318): \emph{for all $M$-generic $F$,
  $p\in F$ implies} 
\[
M[F],[\val(F,\th),\val(F,\sig),\val(F,\pi)]\models
 x_0\in  x_2 \y\phi( x_0, x_1).
\]
Note this is the same as (\ref{eq:2}). Hence, tracing the equivalence
up to (\ref{eq:1}), we can show that $x=\val(G,\th)\in \val(G,n)$
(lines 319--337), finishing the main lemma.

The last 20 lines of the theory show, using absoluteness, the two
instances of Separation for $M[G]$:

\begin{isabelle}
\isacommand{theorem}\isamarkupfalse%
\ separation{\isacharunderscore}in{\isacharunderscore}MG{\isacharcolon}\isanewline
\ \ \isakeyword{assumes}\ \isanewline
\ \ \ \ {\isachardoublequoteopen}{\isasymphi}{\isasymin}formula{\isachardoublequoteclose}\ \isakeyword{and}\isanewline
\ \ \ \  {\isachardoublequoteopen}arity{\isacharparenleft}{\isasymphi}{\isacharparenright}\ {\isacharequal}\ {\isadigit{1}}\ {\isasymor}\ arity{\isacharparenleft}{\isasymphi}{\isacharparenright}{\isacharequal}{\isadigit{2}}{\isachardoublequoteclose}\isanewline
\ \ \isakeyword{shows}\ \ \isanewline
\ \ \ \ {\isachardoublequoteopen}{\isasymforall}a{\isasymin}{\isacharparenleft}M{\isacharbrackleft}G{\isacharbrackright}{\isacharparenright}{\isachardot}\isanewline 
 \ \ \ \ \  separation{\isacharparenleft}{\isacharhash}{\isacharhash}M{\isacharbrackleft}G{\isacharbrackright}{\isacharcomma}{\isasymlambda}x{\isachardot}sats{\isacharparenleft}M{\isacharbrackleft}G{\isacharbrackright}{\isacharcomma}{\isasymphi}{\isacharcomma}{\isacharbrackleft}x{\isacharcomma}a{\isacharbrackright}{\isacharparenright}{\isacharparenright}{\isachardoublequoteclose}
\end{isabelle}
   
%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "Separation_In_MG"
%%% ispell-local-dictionary: "american"
%%% End: 
